{% extends "base.html" %} {% block content %}
<div class="c-form">
  <div class="container pt-5">
    <div class="row">
      {% if user_role == 'COORDINADOR' %}
          <div class="col">
              <a class="c-btn c-btn-primary c-btn-block mb-3" href="./menu-manager">Menu</a>
          </div>
      {% elif user_role == 'VENDEDOR' %}
          <div class="col">
              <a class="c-btn c-btn-primary c-btn-block mb-3" href="./menu-salesman">Menu</a>
          </div>
      {% endif %}
      <div class="col">
          <a class="c-btn c-btn-primary c-btn-block mb-3" href="./logout">Salir</a>
      </div>
    </div>
    <h2 class="c-headings c-headings__h3 mb-4 mt-4">
      Detalle Caja: {{ salesman.employee.user.first_name
      }} {{ salesman.employee.user.last_name }}
    </h2>
    <table class="c-table">
      <thead>
        <tr>
          <th class="c-table__box">Cliente</th>
          <th class="c-table__box">Valor</th>
          <th class="c-table__box">Cuotas</th>
          <th class="c-table__box">Interés</th>
        </tr>
      </thead>
      <tbody>
        {% for loan_detail in loans_details %}
        <tr>
          <td class="c-table__box">{{ loan_detail.client_name }}</td>
          <td class="c-table__box">$-{{ '{:,.0f}'.format(loan_detail.loan_amount) }}</td>
          <td class="c-table__box">{{ '{:,.0f}'.format(loan_detail.loan_dues) }}</td>
          <td class="c-table__box">{{ '{:,.0f}'.format(loan_detail.loan_interest) }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- Tabla para los retiros -->
    <h2 class="c-headings c-headings__h3 mb-4 mt-4">Retiros</h2>
    <table class="c-table">
      <thead>
        <tr>
          <th class="c-table__box">Descripción</th>
          <th class="c-table__box">Valor</th>
          <!-- <th class="c-table__box">Estado</th> -->
          <th class="c-table__box">Adjunto</th>
        </tr>
      </thead>
      <tbody>
        {% for withdrawal_detail in withdrawal_details %}
        <tr>
          <td class="c-table__box">{{ withdrawal_detail.description }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(withdrawal_detail.amount) }}</td>
          <!-- <td class="c-table__box">
            {% if withdrawal_detail.approval_status == 'PENDIENTE' %}
            <span class="badge text-bg-warning"
              >{{ withdrawal_detail.approval_status }}</span
            >
            {% elif withdrawal_detail.approval_status == 'APROBADA' %}
            <span class="badge text-bg-success"
              >{{ withdrawal_detail.approval_status }}</span
            >
            {% elif withdrawal_detail.approval_status == 'RECHAZADA' %}
            <span class="badge text-bg-danger"
              >{{ withdrawal_detail.approval_status }}</span
            >
            {% endif %}
          </td>
          Estado del retiro -->
          <td class="c-table__box">
            <!-- Enlace para ver el adjunto si existe -->
            {% if withdrawal_detail.attachment %}
            <button class="c-btn c-btn-primary c-btn-details" data-target="modal{{ loop.index }}"> <i  class="bi bi-eye" title="details"></i> </button>
            <div class="c-modal" id="modal{{ loop.index }}">
              <img class="img-attachment" src="{{ url_for('static', filename='images/' +  withdrawal_detail.attachment ) }}" alt="Imagen de la transacción">
            </div>
            {% else %} N/A {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Tabla para los ingresos -->
    <h2 class="c-headings c-headings__h3 mb-4 mt-4">Ingresos</h2>
    <table class="c-table">
      <thead>
        <tr>
          <th class="c-table__box">Descripción</th>
          <th class="c-table__box">Valor</th>
          <!-- <th class="c-table__box">Estado</th>
          <th class="c-table__box">Fecha</th> -->
          <th class="c-table__box">Adjunto</th>
        </tr>
      </thead>
      <tbody>
        {% for income_detail in income_details %}
        <tr>
          <td class="c-table__box">{{ income_detail.description }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(income_detail.amount) }}</td>
          <!-- <td class="c-table__box">
            {% if income_detail.approval_status == 'PENDIENTE' %}
            <span class="badge text-bg-warning"
              >{{ income_detail.approval_status }}</span
            >
            {% elif income_detail.approval_status == 'APROBADA' %}
            <span class="badge text-bg-success"
              >{{ income_detail.approval_status }}</span
            >
            {% elif income_detail.approval_status == 'RECHAZADA' %}
            <span class="badge text-bg-danger"
              >{{ income_detail.approval_status }}</span
            >
            {% endif %}
          </td>
          <td class="c-table__box">{{ income_detail.date }}</td> -->
          <!-- Estado del ingreso -->
          <td class="c-table__box">
            <!-- Enlace para ver el adjunto si existe -->
            {% if income_detail.attachment %}
            <button class="c-btn c-btn-primary c-btn-details" data-target="modal{{ loop.index }}" title="details"><i  class="bi bi-eye"></i> </button>
            <div class="c-modal" id="modal{{ loop.index }}">
              <img class="img-attachment" src="{{ url_for('static', filename='images/' +  income_detail.attachment ) }}" alt="Imagen de la transacción">
            </div>
            {% else %} N/A {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Tabla para los gastos -->
    <h2 class="c-headings c-headings__h3 mb-4 mt-4">Gastos</h2>
    <table class="c-table">
      <thead>
        <tr>
          <th class="c-table__box">Descripción</th>
          <th class="c-table__box">Valor</th>
          <!-- <th class="c-table__box">Estado</th> -->
          <th class="c-table__box">Adjunto</th>
        </tr>
      </thead>
      <tbody>
        {% for expense_detail in expense_details %}
        <tr>
          <td class="c-table__box">{{ expense_detail.description }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(expense_detail.amount) }}</td>
          <!-- <td class="c-table__box">
            {% if expense_detail.approval_status == 'PENDIENTE' %}
            <span class="badge text-bg-warning"
              >{{ expense_detail.approval_status }}</span
            >
            {% elif expense_detail.approval_status == 'APROBADA' %}
            <span class="badge text-bg-success"
              >{{ expense_detail.approval_status }}</span
            >
            {% elif expense_detail.approval_status == 'RECHAZADA' %}
            <span class="badge text-bg-danger"
              >{{ expense_detail.approval_status }}</span
            >
            {% endif %}
          </td>  -->
          <td class="c-table__box">
            <!-- Enlace para ver el adjunto si existe -->
            {% if expense_detail.attachment %}
            <button class="c-btn c-btn-primary c-btn-details" data-target="modal{{ loop.index }}" title="details"><i  class="bi bi-eye"></i> </button>
            <div class="c-modal" id="modal{{ loop.index }}">
              <img class="img-attachment" src="{{ url_for('static', filename='images/' +  expense_detail.attachment ) }}" alt="Imagen de la transacción">
            </div>
            {% else %} N/A {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Tabla para los préstamos de renovación activos -->
    <h2 class="c-headings c-headings__h3 mb-4 mt-4">Renovaciones Activas</h2>
    <table class="c-table">
      <thead>
        <tr>
          <th class="c-table__box">Cliente</th>
          <th class="c-table__box">Valor</th>
          <th class="c-table__box">Cuotas</th>
          <th class="c-table__box">Interés</th>
        </tr>
      </thead>
      <tbody>
        {% for renewal_detail in renewal_loan_details %}
        <tr>
          <td class="c-table__box">{{ renewal_detail.client_name }}</td>
          <td class="c-table__box">$-{{ '{:,.0f}'.format(renewal_detail.loan_amount) }}</td>
          <td class="c-table__box">{{ '{:,.0f}'.format(renewal_detail.loan_dues) }}</td>
          <td class="c-table__box">{{ '{:,.0f}'.format(renewal_detail.loan_interest) }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- Agregar esta tabla para los clientes con cuotas en mora -->
    <h2 class="c-headings c-headings__h3 mb-4 mt-4">No Pago</h2>
    <table class="c-table">
      <thead>
        <tr>
          <th class="c-table__box">Cliente</th>
          <th class="c-table__box">C. MORA</th>
          <th class="c-table__box">Saldo</th>
          <th class="c-table__box">Valor Total</th>
        </tr>
      </thead>
      <tbody>
        {% for client_in_arrears in clients_in_arrears %}
        <tr>
          <td class="c-table__box">{{ client_in_arrears.client_name }}</td>
          <td class="c-table__box">{{ client_in_arrears.arrears_count }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(client_in_arrears.overdue_balance) }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(client_in_arrears.total_loan_amount) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h2 class="c-headings c-headings__h3 mb-4 mt-4">Pago</h2>
    <table class="c-table">
      <thead>
        <tr>
          <th class="c-table__box">Cliente</th>
          <th class="c-table__box">Vr. Pago</th>
          <th class="c-table__box">Vr. Prestamo</th>
          <th class="c-table__box">Fecha de Pago</th>
          <th class="c-table__box">Saldo</th>
          {% if user_role == 'VENDEDOR' %}
          <th class="c-table__box">Acción</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for payment_detail in payment_details %}
        <tr>
          <td class="c-table__box">{{ payment_detail.client_name }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(payment_detail.payment_amount) }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(payment_detail.total_credit) }}</td>
          <td class="c-table__box"> {{ payment_detail.payment_date }}</td>
          <td class="c-table__box">${{ '{:,.0f}'.format(payment_detail.remaining_balance) }}</td>
          {% if user_role == 'VENDEDOR' %}
            <td class="c-table__box">
              <a type="button" class="c-btn c-btn-primary js-btn-editar-pago cuota-label"
                style="width: 60%; padding: 0.4rem 0;"
                data-id="{{ payment_detail.loan_id }}"
                data-installment-id="{{ payment_detail.installment_id }}"
                data-overdue-amount="{{ payment_detail.total_credit }}"
                data-toggle="modal"
                data-target="#editPaymentModal">
                <i class="bi bi-pencil"></i>
              </a>
          </a>
            </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
</div>

  </div>
</div>


<!-- Modal para editar el pago -->
<div class="modal fade" id="editPaymentModal" tabindex="-1" role="dialog" aria-labelledby="editPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPaymentModalLabel">Editar Pago</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="editPaymentForm" action="/payments/edit" method="POST">
        <div class="modal-body">
          <!-- Campos para editar el pago -->
          <div class="form-group">
            <label for="customPayment">Nuevo Valor del Pago</label>
            <input type="hidden" name="loanId" value="{{ loan_id }}">
            <input type="hidden" name="InstallmentId" value="{{ installment_id }}">
            <input type="text" class="form-control" id="customPayment" name="customPayment">
          </div>
          <div class="form-group">
        </div>
        <div class="modal-footer">
          <button type="submit" class="c-btn c-btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Script para enviar los datos del formulario a través de AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function () {

  var btnsPagar = document.querySelectorAll('.js-btn-editar-pago');

  // Agrega un evento de clic a cada botón de pago
  btnsEditarPago.forEach(function (btn) {
    btn.addEventListener('click', function () {
        // Obtén el valor de la cuota del botón de pago
        var installmentValue = parseFloat(this.getAttribute('data-installment-id'));
        console.log(installmentValue);
        var overdueAmount = parseFloat(this.getAttribute('data-overdue-amount'));
        var loanId = this.getAttribute('data-id');

        // Almacena el ID del préstamo en un campo oculto
        document.getElementById('loanId').value = loanId;
        document.getElementById('installmentValue').value = installmentValue;
    });
  });


  $(document).ready(function() {
    // Escucha el evento submit del formulario
    $('#editPaymentForm').submit(function(event) {
      // Evita que el formulario se envíe de forma tradicional
      // event.preventDefault();
      // Serializa los datos del formulario
      var formData = $(this).serialize();
      // Realiza una petición AJAX al endpoint de edición de pago
      $.ajax({
        type: 'POST',
        url: '/payments/edit',
        data: formData,
        success: function(response) {
          // Muestra un mensaje de éxito o realiza alguna otra acción
          alert('Pago actualizado exitosamente');
          // Cierra la modal después de actualizar el pago
          $('#editPaymentModal').modal('hide');
          // Opcional: recargar la página para actualizar la tabla de pagos
          location.reload();
        },
        error: function(xhr, status, error) {
          // Maneja errores de la petición AJAX
          alert('Error al actualizar el pago: ' + error);
        }
      });
    });
  });
});
</script>
{% endblock %}
